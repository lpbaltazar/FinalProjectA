SELECT USERID, SESSIONID, EXTRACT(YEAR_MONTH FROM SESSION_STARTDT) AS MONTH, YEARWEEK(SESSION_STARTDT, 1) AS WEEK, DATE(SESSION_STARTDT) AS DATE, ((VIDEO_DURATION*1.0)/(USR_ACT_TOT_WATCHING_DUR*1.0))*100 AS COMPLETION_70
FROM events_data
WHERE ((VIDEO_DURATION*1.0)/(USR_ACT_TOT_WATCHING_DUR*1.0)) >= 0.70
INTO OUTFILE '/var/lib/mysql-files/for_completion_total.csv'
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n';

SELECT EXTRACT(YEAR_MONTH FROM SESSION_STARTDT) AS MONTH, USERID, SESSIONID, VIDEO_DURATION, USR_ACT_TOT_WATCHING_DUR 
FROM events_data
GROUP BY EXTRACT(YEAR_MONTH FROM SESSION_STARTDT)
INTO OUTFILE '/var/lib/mysql-files/for_completion_monthly.csv'
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n';

SELECT YEARWEEK(SESSION_STARTDT) AS WEEK, USERID, SESSIONID, VIDEO_DURATION, USR_ACT_TOT_WATCHING_DUR
FROM events_data
GROUP BY YEARWEEK(SESSION_STARTDT)
INTO OUTFILE '/var/lib/mysql-files/for_completion_weekly.csv'
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n';


##### C O U N T I N G #######
SELECT YEARWEEK(SESSION_STARTDT, 1) AS WEEK, COUNT(USERID) AS NUMCUST, COUNT(SESSIONID) AS NUMSESSIONS
FROM events_data
WHERE ((VIDEO_DURATION*1.0)/(USR_ACT_TOT_WATCHING_DUR*1.0)) < 0.70
GROUP BY YEARWEEK(SESSION_STARTDT, 1)

SELECT EXTRACT(YEAR_MONTH FROM SESSION_STARTDT) AS MONTH, COUNT(USERID) AS NUMCUST, COUNT(SESSIONID) AS NUMSESSIONS
FROM events_data
WHERE ((VIDEO_DURATION*1.0)/(USR_ACT_TOT_WATCHING_DUR*1.0)) < 0.70
GROUP BY EXTRACT(YEAR_MONTH FROM SESSION_STARTDT)

SELECT COUNT(USERID) AS NUMCUST, COUNT(SESSIONID) AS NUMSESSIONS
FROM events_data
WHERE ((VIDEO_DURATION*1.0)/(USR_ACT_TOT_WATCHING_DUR*1.0)) < 0.70

SELECT YEARWEEK(SESSION_STARTDT, 1) AS WEEK, COUNT(USERID) AS NUMCUST, COUNT(SESSIONID) AS NUMSESSIONS
FROM events_data
GROUP BY YEARWEEK(SESSION_STARTDT, 1)

SELECT DATE(SESSION_STARTDT) AS DATE, COUNT(USERID) AS NUMCUST, COUNT(SESSIONID) AS NUMSESSIONS
FROM events_data
WHERE (SUM(USR_ACT_TOT_WATCHING_DUR)/SUM(VIDEO_DURATION)) < 0.70
GROUP BY DATE(SESSION_STARTDT)


SELECT EXTRACT(YEAR_MONTH FROM SESSION_STARTDT) AS MONTH, COUNT(USERID) AS NUMCUST, COUNT(SESSIONID) AS NUMSESSIONS
FROM events_data
GROUP BY EXTRACT(YEAR_MONTH FROM SESSION_STARTDT)

SELECT COUNT(USERID) AS NUMCUST, COUNT(SESSIONID) AS NUMSESSIONS
FROM events_data

#### EXTRACTING AND COUNTING SESSION FREQUENCY ####
SELECT YEARWEEK(SESSION_STARTDT, 1) AS WEEK, USERID, COUNT(SESSIONID)
FROM events_data
WHERE ((USR_ACT_TOT_WATCHING_DUR*1.0)/(VIDEO_DURATION*1.0)) >= 0.70
GROUP BY YEARWEEK(SESSION_STARTDT, 1)

SELECT EXTRACT(YEAR_MONTH FROM SESSION_STARTDT) AS MONTH, USERID, COUNT(SESSIONID)
FROM events_data
WHERE ((USR_ACT_TOT_WATCHING_DUR*1.0)/(VIDEO_DURATION*1.0)) >= 0.70
GROUP BY EXTRACT(YEAR_MONTH FROM SESSION_STARTDT)

SELECT USERID, COUNT(SESSIONID)
FROM events_data
WHERE ((USR_ACT_TOT_WATCHING_DUR*1.0)/(VIDEO_DURATION*1.0)) >= 0.70


#### TOTAL COMPLETION RATE ####
SELECT YEARWEEK(SESSION_STARTDT, 1) AS WEEK, USERID, (SUM(USR_ACT_TOT_WATCHING_DUR)/SUM(VIDEO_DURATION))*100 AS AVGCOMPLETION
FROM events_data
GROUP BY YEARWEEK(SESSION_STARTDT, 1), USERID

SELECT EXTRACT(YEAR_MONTH FROM SESSION_STARTDT) AS MONTH, USERID, (SUM(USR_ACT_TOT_WATCHING_DUR)/SUM(VIDEO_DURATION))*100 AS AVGCOMPLETION
FROM events_data
GROUP BY EXTRACT(YEAR_MONTH FROM SESSION_STARTDT), USERID

SELECT USERID, (SUM(USR_ACT_TOT_WATCHING_DUR)/SUM(VIDEO_DURATION))*100 AS AVGCOMPLETION
FROM events_data
